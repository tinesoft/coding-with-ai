# Aider Configuration for TaskFlow

## Project Context
TaskFlow - Full-stack task management system
- React + Next.js 14 (App Router) + TypeScript
- PostgreSQL + Prisma ORM
- NextAuth.js authentication
- Repository → Service → API → Component architecture

## Edit Mode Preferences

### Use Diff Format When:
- Making small, focused changes to existing code
- Fixing bugs or typos
- Updating function signatures
- Modifying configuration files
- Making quick adjustments

### Use Whole-File Mode When:
- Creating new files from scratch
- Large refactoring that touches many lines
- Restructuring component hierarchy
- Rewriting complex logic
- Adding multiple functions/methods

## File Organization

### Source Code Structure
```
src/
├── app/                 # Next.js App Router (routes, layouts)
├── components/          # React components
│   ├── ui/              # Base UI components
│   ├── features/        # Feature-specific components
│   └── layouts/         # Layout components
├── lib/                 # Libraries and configurations
├── server/              # Server-side code
│   ├── api/             # API handlers
│   ├── services/        # Business logic
│   └── repositories/    # Data access
├── types/               # TypeScript definitions
└── utils/               # Utility functions
```

### Test Organization
- Place tests next to implementation files
- Use `*.test.ts` for unit/integration tests
- Use `*.spec.ts` for E2E tests
- Mirror source structure in `tests/` directory for shared test utilities

### Public API Structure
- Use `index.ts` for public APIs
- Export types and implementations together
- Keep internal implementation files private

## Commit Message Format

Follow Conventional Commits specification:

### Feature Additions
```
feat: add task assignment notification system

- Implement email notification service
- Add in-app notification component
- Create notification repository
- Add unit tests for notification service
```

### Bug Fixes
```
fix: resolve task status update race condition

- Add optimistic locking to task updates
- Update repository to handle version conflicts
- Add test case for concurrent updates
```

### Refactoring
```
refactor: extract task permissions logic to service

- Move permission checks from component to taskService
- Add TaskPermissionService with role-based checks
- Update components to use new service
- Add comprehensive permission tests
```

### Test Changes
```
test: add missing edge cases for task creation

- Test empty title validation
- Test unauthorized user scenarios
- Test project access verification
```

### Documentation
```
docs: update API documentation for task endpoints

- Add request/response examples
- Document error codes
- Include authentication requirements
```

### Code Style/Formatting
```
style: format codebase with Prettier

- No functional changes
- Consistent code formatting across files
```

### Performance Improvements
```
perf: optimize task list query performance

- Add database indexes on frequently queried fields
- Implement Redis caching for project tasks
- Reduce N+1 queries with Prisma includes
```

### Chores (maintenance, dependencies)
```
chore: update dependencies to latest versions

- Update Next.js to 14.2
- Update Prisma to 5.15
- Update testing libraries
```

## Aider-Specific Workflows

### Workflow 1: Feature Implementation
```bash
# Start with data model
aider prisma/schema.prisma
# Prompt: "Add Task model with title, description, status, assignee relation"

# Create types
aider src/types/task.ts
# Prompt: "Create TypeScript types for Task based on Prisma schema"

# Build repository layer
aider src/server/repositories/taskRepository.ts
# Prompt: "Create repository with CRUD operations for tasks"

# Build service layer
aider src/server/services/taskService.ts src/server/repositories/taskRepository.ts
# Prompt: "Create service layer with business logic and validation"

# Create API route
aider src/app/api/tasks/route.ts src/server/services/taskService.ts
# Prompt: "Create API route with authentication and error handling"

# Build component
aider src/components/features/TaskList/TaskList.tsx
# Prompt: "Create TaskList component that fetches and displays tasks"

# Add tests
aider src/server/services/taskService.ts src/server/services/taskService.test.ts
# Prompt: "Add comprehensive tests for taskService"
```

### Workflow 2: Bug Fix
```bash
# Include related files
aider src/server/services/taskService.ts src/server/repositories/taskRepository.ts tests/task-bugs.md

# Provide context in prompt:
# "There's a race condition when multiple users update task status simultaneously.
#  The issue is in taskService.updateStatus. Add optimistic locking."
```

### Workflow 3: Refactoring
```bash
# Include all files affected by refactor
aider src/components/TaskCard.tsx src/components/ProjectCard.tsx src/hooks/usePermissions.ts

# Prompt:
# "Extract duplicate permission checking logic from TaskCard and ProjectCard
#  into a reusable usePermissions hook. Maintain all existing functionality."
```

## Coding Standards for Aider

### TypeScript Rules
```typescript
// ✅ Always use explicit types
function calculateProgress(tasks: Task[]): ProgressMetrics {
  // Implementation
}

// ✅ Use interfaces for objects
interface Task {
  id: string;
  title: string;
  status: TaskStatus;
}

// ✅ Never use 'any' type
// ❌ Bad: function process(data: any) { }
// ✅ Good: function process(data: unknown) { }
```

### Error Handling
```typescript
// Always handle errors explicitly
try {
  const result = await performOperation();
  return result;
} catch (error) {
  if (error instanceof ValidationError) {
    return handleValidationError(error);
  }
  if (error instanceof AuthorizationError) {
    return handleAuthError(error);
  }
  logger.error('Unexpected error', { error });
  throw new InternalServerError('Operation failed');
}
```

### Component Structure
```typescript
// Preferred component structure
interface ComponentProps {
  // Props definition
}

export function Component({ prop1, prop2 }: ComponentProps) {
  // 1. Hooks at top
  const [state, setState] = useState();
  const data = useQuery();
  
  // 2. Event handlers
  const handleClick = () => {
    // Handler logic
  };
  
  // 3. Effects
  useEffect(() => {
    // Effect logic
  }, []);
  
  // 4. Render
  return (
    <div>
      {/* JSX */}
    </div>
  );
}
```

## Architecture Patterns

### Repository Pattern
```typescript
// All database access goes through repositories
export const taskRepository = {
  async findById(id: string): Promise<Task | null> {
    return prisma.task.findUnique({ where: { id } });
  },
  
  async create(data: CreateTaskData): Promise<Task> {
    return prisma.task.create({ data });
  }
};
```

### Service Pattern
```typescript
// Business logic in services
export const taskService = {
  async createTask(data: CreateTaskDTO, userId: string): Promise<Task> {
    // 1. Validate
    validateTaskData(data);
    
    // 2. Check permissions
    await checkProjectAccess(data.projectId, userId);
    
    // 3. Create via repository
    const task = await taskRepository.create({
      ...data,
      createdBy: userId
    });
    
    // 4. Side effects (notifications, etc.)
    await notificationService.notifyTaskCreated(task);
    
    return task;
  }
};
```

### API Route Pattern
```typescript
// API routes handle HTTP concerns only
export async function POST(request: NextRequest) {
  try {
    // 1. Authenticate
    const session = await getServerSession();
    if (!session) {
      return Response.json({ error: 'Unauthorized' }, { status: 401 });
    }
    
    // 2. Validate input
    const body = await request.json();
    const validatedData = createTaskSchema.parse(body);
    
    // 3. Call service
    const task = await taskService.createTask(validatedData, session.user.id);
    
    // 4. Return response
    return Response.json(task, { status: 201 });
    
  } catch (error) {
    return handleApiError(error);
  }
}
```

## Testing Guidelines

### Test Structure
```typescript
describe('TaskService', () => {
  describe('createTask', () => {
    it('creates task with valid data', async () => {
      // Arrange
      const taskData = { title: 'Test Task', projectId: 'proj-1' };
      
      // Act
      const task = await taskService.createTask(taskData, userId);
      
      // Assert
      expect(task).toMatchObject(taskData);
      expect(task.id).toBeDefined();
    });
    
    it('throws ValidationError when title is empty', async () => {
      await expect(
        taskService.createTask({ title: '', projectId: 'proj-1' }, userId)
      ).rejects.toThrow(ValidationError);
    });
  });
});
```

### Test Coverage Requirements
- Services and business logic: >90%
- API routes: >80%
- React components: >80%
- Utilities: >95%

## Common Aider Commands

### Working with Related Files
```bash
# Add multiple related files
aider src/components/TaskCard.tsx src/components/TaskCard.test.tsx src/components/TaskCard.module.css

# Add files by pattern
aider src/server/services/*.ts

# Add test files with implementation
aider src/utils/validation.ts src/utils/validation.test.ts
```

### Project-Wide Changes
```bash
# Update import paths across multiple files
aider $(git ls-files '*.ts' '*.tsx')
# Prompt: "Update all imports from @/lib/utils to @/utils"

# Apply consistent pattern across components
aider src/components/**/*.tsx
# Prompt: "Update all components to use new error handling pattern"
```

## Important Project Rules

### Security Requirements
- All API routes MUST check authentication
- All user inputs MUST be validated with Zod
- Never expose sensitive data in error messages
- Use environment variables for secrets (never hardcode)

### Type Safety Requirements
- TypeScript strict mode is enabled
- No `any` types allowed (use `unknown` with type guards if needed)
- All function parameters and return types must be explicitly typed
- Enable all strict TypeScript options

### Code Quality Requirements
- Functions should be under 50 lines
- Files should be under 300 lines
- Test coverage must be >80% for new code
- All exports must have JSDoc comments

### Performance Requirements
- Implement pagination for lists
- Use database indexes for frequently queried fields
- Cache expensive operations with Redis
- Lazy load large components

## Questions to Consider

Before making changes, consider:

1. **Architecture:** Does this follow repository → service → API → component pattern?
2. **Security:** Are authentication and authorization properly handled?
3. **Testing:** What tests need to be added or updated?
4. **Performance:** Will this impact query performance or bundle size?
5. **Breaking Changes:** Will this require updates elsewhere in the codebase?
6. **Type Safety:** Are all types explicitly defined with no `any` types?

## Common Pitfalls to Avoid

- ❌ Don't access database directly from components
- ❌ Don't use `any` type anywhere
- ❌ Don't mutate state or props directly
- ❌ Don't skip authentication checks in API routes
- ❌ Don't ignore errors (always handle explicitly)
- ❌ Don't use console.log in production code
- ❌ Don't commit secrets or environment variables

## Project Commands

```bash
# Development
npm run dev                # Start development server
npm run build              # Build for production
npm test                   # Run tests
npm run type-check         # TypeScript type checking
npm run lint               # Lint code

# Database
npm run db:migrate         # Run Prisma migrations
npm run db:seed            # Seed database
npm run db:studio          # Open Prisma Studio

# Testing
npm test -- --watch        # Run tests in watch mode
npm run test:coverage      # Generate coverage report
npm run test:e2e           # Run E2E tests
```

---

**Project:** TaskFlow Task Management System
**Last Updated:** October 2025
**Maintainer:** Development Team
